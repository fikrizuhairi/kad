<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Jemputan Perkahwinan — Isma & Fikri</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{--accent:#a67c52;--muted:#6b7280;--glass:rgba(255,255,255,0.75)}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(180deg,#f8f6f4 0%,#ffffff 100%);color:#111;overflow-x:hidden;-webkit-font-smoothing:antialiased}

    .app{max-width:420px;margin:auto;overflow:hidden;position:relative;min-height:100vh;scroll-snap-type:y mandatory;overflow-y:scroll;-webkit-overflow-scrolling:touch;padding-bottom:100px}

    section{scroll-snap-align:start;min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative}

    .bg-video img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1}

    .intro-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#cc5500;z-index:2;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
    .intro-text .kecil{font-family:'Playfair Display',serif;font-size:14px;color:#000;margin-bottom:6px;font-weight:400;text-shadow:none}
    .intro-text .besar{font-family:'Playfair Display',serif;font-size:40px;font-weight:700;letter-spacing:1px;line-height:1.2}
    .intro-text .besar span{display:block}
    .intro-text .tarikh{font-family:'Poppins',sans-serif;font-size:16px;color:#222;margin-top:10px;font-weight:500;text-shadow:none}
    .intro-text .lokasi{font-family:'Poppins',sans-serif;font-size:14px;color:#222;margin-top:3px;font-weight:500;text-shadow:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .content{background:rgba(255,255,255,0.8);backdrop-filter:blur(6px);border-radius:16px;padding:24px;box-shadow:0 8px 20px rgba(0,0,0,0.05);position:relative;z-index:3;margin:20px;max-width:420px}

    .parent-name,.couple-name{font-family:'Playfair Display',serif;font-size:18px;color:#2b2b2b;margin-bottom:8px;text-align:center;font-weight:700}

    h2{font-size:18px;font-weight:600;color:var(--accent);margin:16px 0 8px;text-align:center}
    p{font-size:15px;color:#222;line-height:1.6;margin-bottom:8px;text-align:center}

    .btn{display:flex;align-items:center;justify-content:center;gap:8px;background:var(--accent);color:#fff;padding:12px 20px;border-radius:12px;font-weight:600;text-decoration:none;margin:6px auto;text-align:center;border:none;transition:0.2s;width:100%;max-width:300px}
    .btn i{font-size:18px}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
    .btn:hover{opacity:0.9}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px}
    .grid img{width:100%;height:90px;object-fit:cover;border-radius:8px;cursor:pointer;transition:0.3s}
    .grid img:hover{opacity:0.9;transform:scale(1.03)}

    .modal{display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.8)}
    .modal-content{margin:auto;display:block;max-width:90%;max-height:90%;border-radius:10px}
    .close{position:absolute;top:15px;right:25px;color:white;font-size:30px;font-weight:bold;cursor:pointer}

    form.rsvp{display:none;flex-direction:column;gap:8px;margin-top:10px}
    form.rsvp.active{display:flex}
    .rsvp input[type="text"],.rsvp input[type="number"],.rsvp select{padding:10px;border-radius:8px;border:1px solid #ddd;font-size:14px}
    .rsvp .row{display:flex;gap:8px}
    .rsvp .row .col{flex:1}

    .countdown{display:flex;justify-content:center;gap:8px;margin-top:12px}
    .countdown div{background:#f1f1f1;padding:8px 10px;border-radius:8px;min-width:54px}
    .countdown .num{font-weight:700;font-size:16px}
    .countdown .lbl{font-size:11px;color:var(--muted)}

    footer{font-size:12px;color:var(--muted);margin-top:20px;text-align:center}

    .bottom-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:10px;z-index:50;
      width:calc(100% - 60px);max-width:420px;background:rgba(0,0,0,0.7);
      border-radius:12px;padding:8px 8px;box-shadow:0 6px 14px rgba(0,0,0,0.08);
      display:flex;gap:12px;align-items:center;justify-content:space-around;overflow:visible
    }

    .bottom-bar .icon-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;background:transparent;color:#fff;font-size:20px;text-decoration:none;gap:4px;cursor:pointer}
    .bottom-bar .icon-btn i{color:#fff;font-size:20px}
    .bottom-bar .icon-btn span{font-size:11px;color:#fff;line-height:1}

    /* contact card (big) that appears above content */
    .contact-card{display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:110px;z-index:80;width:calc(100% - 40px);max-width:420px;background:#e8dcc6;border-radius:18px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,0.12)}
    .contact-card h3{text-align:center;margin-bottom:8px;font-family:'Playfair Display',serif;font-size:20px;color:#1f1f1f}
    .contact-list{margin-top:8px}
    .contact-row{display:flex;align-items:center;justify-content:space-between;padding:12px 6px;border-radius:10px}
    .contact-info{display:flex;flex-direction:column}
    .contact-info .name{font-size:16px;font-weight:600;color:#111}
    .contact-info .role{font-size:13px;font-style:italic;color:#6b5f50}
    .contact-actions{display:flex;gap:12px;align-items:center}
    .contact-actions a{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:8px;background:var(--accent);border:none;text-decoration:none;color:#fff}

    @media (max-width:420px){.contact-card{width:calc(100% - 28px);padding:16px}}

    /* ucapan bubbles */
    .bubbles{display:flex;flex-direction:column;gap:8px;margin:12px 0}
    .bubble{align-self:flex-start;background:#fff4e9;border:1px solid #f0e1cf;padding:10px 14px;border-radius:18px;max-width:90%;box-shadow:0 6px 12px rgba(0,0,0,0.06);}    
    .bubble .meta{font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:600}
    .bubble .msg{font-size:14px;color:#222;line-height:1.4}

  .map-popup iframe{width:100%;height:60vh;max-height:760px;border:none;border-radius:10px;margin-top:8px}
@media (max-width:420px){.map-popup iframe{height:65vh;max-height:820px}}

/* small helper styles for control row */
.controls{display:flex;gap:8px;justify-content:center;margin-top:8px}
.controls button{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);background:#fff;cursor:pointer}
.controls .danger{background:#f8d7da;border-color:#f5c2c7}
  </style>
</head>
<body>
  <div class="app">
    <section>
      <div class="bg-video">
        <img src="https://jemputan.me/images/upload/design/1723691062_FLO102_Cover.png" alt="Wedding Background" />
      </div>

      <div class="intro-text">
        <div class="kecil">WALIMATULURUS</div><br><br>
        <div class="besar"><span>ISMA</span><span>&amp;</span><span>FIKRI</span></div><br>
        <div class="tarikh">03 JANUARI 2026 | SABTU</div>
        <div class="lokasi">WHITE HOUSE EVENT SPACE, DUNGUN</div>
      </div>
    </section>

    <section>
      <div class="content" id="mainCard">
        <p>Assalamualaikum &amp; Salam Sejahtera</p>
        <div class="parent-name"><strong>HJ. MOHD SHUHAIMI BIN DAUD</strong></div>
        <div class="parent-name"><strong>&amp;</strong></div>
        <div class="parent-name"><strong>HJH. NOR AZILA BINTI RAMLI</strong></div>
        <p>Dengan penuh kesyukuran kami menjemput,<br>Dato’ | Datin | Tuan | Puan | Encik | Cik<br>ke majlis perkahwinan puteri kami</p><br>
        <div class="couple-name"><strong>SITI ISMAHANI IZZATI BINTI MOHD SHUHAIMI</strong></div>
        <div class="parent-name"><strong>&amp;</strong></div>
        <div class="couple-name"><strong>MUHAMMAD FIKRI BIN ZUHAIRI</strong></div>

        <h2>Butiran Majlis</h2>
        <p><strong>Tarikh:</strong> Sabtu, 03 Januari 2026<br><strong>Masa:</strong> 11:00 pagi - 4:00 petang<br><strong>Tempat:</strong> White House Event Space Dungun</p>

        <h2>Atur Cara</h2>
        <p><strong>Jamuan:</strong> 11.00 AM – 4.00 PM<br><strong>Ketibaan Pengantin:</strong> 12.00 PM</p>

        <h2>Gambar</h2>
        <div class="grid">
          <img src="https://i.postimg.cc/3RRKKKHH/265f0c1f-9af7-4fb7-956d-50d064a0eba4.jpg" alt="1">
          <img src="https://i.postimg.cc/KcP9ZtJy/A24C2718-C6BC-4653-B516-9741E7B213BF-1-105-c.jpg" alt="2">
          <img src="https://i.postimg.cc/T1VPHTMh/8EC8700E-DA47-4FF0-9F84-2FCE47B1A986-1-105-c.jpg" alt="3">
        </div>

        <div id="imageModal" class="modal">
          <span class="close">&times;</span>
          <img class="modal-content" id="modalImg" />
        </div>

        <h2>Ucapan</h2>

        <div class="bubbles" id="bubblesContainer"></div>

        <h2>COUNTING DAYS</h2>
        <div class="countdown" id="countdown">
          <div><div class="num" id="days">0</div><div class="lbl">Hari</div></div>
          <div><div class="num" id="hours">0</div><div class="lbl">Jam</div></div>
          <div><div class="num" id="mins">0</div><div class="lbl">Minit</div></div>
          <div><div class="num" id="secs">0</div><div class="lbl">Saat</div></div>
        </div>

        <footer>Terima kasih — Kami hargai kehadiran dan doa anda.</footer>
      </div>
    </section>
  </div>

  <!-- contact card (shown when Call icon clicked) -->
  <div class="contact-card" id="contactCard" role="dialog" aria-label="contact" style="display:none;bottom:70px;left:50%;transform:translateX(-50%);background:#e8dcc6;color:#222;padding:12px;border-radius:12px;width:300px;box-shadow:0 10px 30px rgba(0,0,0,0.12);">

    <h3>CONTACT</h3>
    <div class="contact-list">
      <div class="contact-row">
        <div class="contact-info">
          <div class="name">Hj. Shuhaimi</div>
          <div class="role">Bapa</div>
        </div>
        <div class="contact-actions">
          <a href="https://wa.me/+60199150821" target="_blank" aria-label="whatsapp"><i class="fa-brands fa-whatsapp"></i></a>
          <a href="tel:+60199150821" aria-label="call"><i class="fa-solid fa-phone"></i></a>
        </div>
      </div>

      <div class="contact-row">
        <div class="contact-info">
          <div class="name">Syafiq</div>
          <div class="role">Abang</div>
        </div>
        <div class="contact-actions">
          <a href="https://wa.me/+60104070205" target="_blank" aria-label="whatsapp"><i class="fa-brands fa-whatsapp"></i></a>
          <a href="tel:+60104070205" aria-label="call"><i class="fa-solid fa-phone"></i></a>
        </div>
      </div>

      <div class="contact-row">
        <div class="contact-info">
          <div class="name">Amalina</div>
          <div class="role">Kakak</div>
        </div>
        <div class="contact-actions">
          <a href="https://wa.me/+601137426966" target="_blank" aria-label="whatsapp"><i class="fa-brands fa-whatsapp"></i></a>
          <a href="tel:+601137426966" aria-label="call"><i class="fa-solid fa-phone"></i></a>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-bar" role="navigation" aria-label="tindakan">
    <div class="icon-btn" id="callBtn" aria-label="panggil"><i class="fa-solid fa-phone"></i><span>Hubungi</span></div>
    <div class="icon-btn" id="mapBtn" aria-label="lokasi">
      <i class="fa-solid fa-location-dot"></i><span>Lokasi</span>
      <div class="map-popup" id="mapPopup" style="display:none;position:absolute;bottom:70px;left:50%;transform:translateX(-50%);background:#e8dcc6;color:#222;padding:12px;border-radius:12px;width:260px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.12);">
        <h4 style="margin:0 0 6px;font-family:'Playfair Display',serif;color:#1f1f1f">Lokasi</h4>
        <p style="margin:0 0 10px;font-size:14px;color:#6b5f50">White House Event Space, Dungun</p>
        <a href="https://maps.app.goo.gl/Z2F3c86dVen1ciR29" target="_blank" style="display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;text-decoration:none;padding:8px;border-radius:8px;margin:6px auto;max-width:200px;gap:8px"><i class="fa-solid fa-map-location-dot"></i><span>Google Maps</span></a>
        <a href="https://ul.waze.com/ul?venue_id=67764271.677839321.39155974" target="_blank" style="display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;text-decoration:none;padding:8px;border-radius:8px;margin:6px auto;max-width:200px;gap:8px"><i class="fa-brands fa-waze"></i><span>Waze</span></a>
      </div>
    </div>
    <div class="icon-btn" id="bottomRsvpBtn" aria-label="rsvp" data-open="rsvp"><i class="fa-regular fa-envelope"></i><span>RSVP</span></div>
  </div>

  <!-- popup small for RSVP choices -->
  <div id="popupRsvp" class="map-popup" style="display:none;position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#e8dcc6;color:#222;padding:12px;border-radius:12px;width:260px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:1000;">
    <h4 style="margin:0 0 6px;font-family:'Playfair Display',serif;color:#1f1f1f">RSVP</h4>
    <p style="margin:0 0 10px;font-size:14px;color:#6b5f50">Pilih tindakan untuk RSVP atau hantarkan ucapan.</p>
    <a id="openInlineRsvp" href="#" style="display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;text-decoration:none;padding:8px;border-radius:8px;margin:6px auto;max-width:200px;gap:8px"><i class="fa-solid fa-clipboard-list"></i><span>Isi RSVP</span></a>
    <a id="openUcapanBtn" href="#" style="display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;text-decoration:none;padding:8px;border-radius:8px;margin:6px auto;max-width:200px;gap:8px"><i class="fa-solid fa-pencil"></i><span>Hantar Ucapan</span></a>
  </div>

  <!-- big iframe-like inline RSVP popup -->
  <div id="popupRsvpIframe" class="map-popup" style="display:none;position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:#e8dcc6;color:#222;padding:12px;border-radius:12px;width:95%;max-width:420px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:1000;">
    <h4 style="margin:0 0 6px;font-family:'Playfair Display',serif;color:#1f1f1f">Isi RSVP</h4>
    <p style="margin:0 0 10px;font-size:14px;color:#6b5f50">Sila lengkapkan borang di bawah.</p>
    <button id="closeRsvpIframeBtn" aria-label="Tutup" style="position:absolute;top:10px;right:12px;background:transparent;border:none;font-size:20px;color:#333;cursor:pointer;z-index:1001">&times;</button>

    <!-- FORM -->
    <form id="rsvpInlineForm" style="display:flex;flex-direction:column;gap:8px;margin-top:6px;">
      <input id="rsvp_nama" name="nama" type="text" placeholder="Nama penuh" required style="padding:10px;border-radius:8px;border:1px solid #ddd;font-size:14px" />
      <input id="rsvp_jumlah" name="jumlah" type="number" min="1" placeholder="Bilangan ahli (cth: 2)" value="1" required style="padding:10px;border-radius:8px;border:1px solid #ddd;font-size:14px" />
      <div style="display:flex;gap:8px;justify-content:center;margin-top:4px">
        <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="hadir" value="Hadir" checked /> Hadir</label>
        <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="hadir" value="Tidak Hadir" /> Tidak Hadir</label>
      </div>

      <button id="rsvpSubmit" type="submit" class="btn" style="margin-top:6px">Hantar RSVP</button>
    </form>

    <div id="rsvpStatus" style="margin-top:8px;font-size:13px;color:#333;display:none"></div>
  </div>

  <!-- ucapan small popup -->
  <div id="ucapanForm" class="map-popup" aria-label="ucapan" style="display:none;position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:#e8dcc6;color:#222;padding:12px;border-radius:12px;width:95%;max-width:420px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:1000;">
    <h4 style="margin:0 0 6px;font-family:'Playfair Display',serif;color:#1f1f1f">Hantar Ucapan</h4>
    <p style="margin:0 0 10px;font-size:14px;color:#6b5f50">Tulis nama dan ucapan anda untuk Isma &amp; Fikri.</p>
    <button id="closeUcapanBtn" aria-label="Tutup" style="position:absolute;top:10px;right:12px;background:transparent;border:none;font-size:20px;color:#333;cursor:pointer;z-index:1001">&times;</button>
    <input id="ucap_name" type="text" placeholder="Nama anda" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px">
    <textarea id="ucap_text" placeholder="Ucapan untuk Isma & Fikri" rows="3" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px"></textarea>
    <a id="submitUcapan" href="#" style="display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;text-decoration:none;padding:8px;border-radius:8px;margin:6px auto;max-width:200px;gap:8px">Hantar</a>
    <div id="ucapanStatus" style="margin-top:8px;font-size:13px;color:#333;display:none"></div>
  </div>

<script>
(function(){
  /* ---------------- CONFIG ----------------
     Gantikan URL di bawah jika perlu.
     Use the Web App URLs you deployed (from previous messages).
  -------------------------------------------------- */
  const UCAPAN_WS_URL = 'https://script.google.com/macros/s/AKfycbxtCQBrjwa83H4pwGzuvJVKaPJdWlQLX7U_PFo8G2MNx1V5RlsdGIvDCMtsJqBK2BAt/exec';
  const RSVP_WS_URL   = 'https://script.google.com/macros/s/AKfycbzIHYp70QawSLYH8K1M1YMgIOE52UjUbB9UrgtUQWsiLhEGpbm60ma70sd3mAL3BdherQ/exec';

  /* ----------------- Utilities ----------------- */
  function escapeHtml(s){ if (typeof s !== 'string') return s||''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

  async function safeJson(resp){
    try { return await resp.json(); } catch(e){ return null; }
  }

  /* ----------------- Retry queue (localStorage) ----------------- */
  const RETRY_KEY = 'ucapan_retry_queue_v1';
  function pushToRetryQueue(entry){
    try {
      const cur = JSON.parse(localStorage.getItem(RETRY_KEY) || '[]');
      cur.push(entry);
      localStorage.setItem(RETRY_KEY, JSON.stringify(cur));
    } catch(e){ console.warn('pushToRetryQueue', e); }
  }
  async function flushRetryQueue(url){
    try {
      const cur = JSON.parse(localStorage.getItem(RETRY_KEY) || '[]');
      if(!cur || !cur.length) return;
      const remaining = [];
      for(const item of cur){
        try {
          const res = await sendWithBeaconOrFetch(url, item);
          // consider boolean {ok:true,via:'beacon'} or parsed success
          if(res && (res.ok === true || res.status === 'success' || res.status === 'ok-nojson' || res === true)) {
            // success -> don't push back
          } else {
            remaining.push(item);
          }
        } catch(e){
          remaining.push(item);
        }
      }
      localStorage.setItem(RETRY_KEY, JSON.stringify(remaining));
    } catch(e){ console.warn('flushRetryQueue', e); }
  }

  /* ----------------- sendWithBeaconOrFetch -----------------
     Try navigator.sendBeacon (fast, fire-and-forget). If not supported
     fallback to fetch with small timeout (2.5s) and keepalive:true.
  -----------------------------------------------------------*/
  function sendWithBeaconOrFetch(url, dataObj){
    if(!url) return Promise.resolve(false);
    // Prefer sendBeacon with urlencoded payload
    try {
      if(navigator && navigator.sendBeacon){
        const payloadStr = new URLSearchParams(dataObj).toString();
        const blob = new Blob([payloadStr], { type: 'application/x-www-form-urlencoded;charset=UTF-8' });
        const ok = navigator.sendBeacon(url, blob); // returns boolean
        return Promise.resolve({ ok: ok, via: 'beacon' });
      }
    } catch(e){
      console.warn('beacon err', e);
    }

    // fallback fetch with timeout
    return new Promise((resolve)=>{
      const controller = new AbortController();
      const timeoutMs = 2500;
      const tid = setTimeout(()=> controller.abort(), timeoutMs);

      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: new URLSearchParams(dataObj).toString(),
        signal: controller.signal,
        keepalive: true,
        cache: 'no-cache'
      }).then(async (resp)=>{
        clearTimeout(tid);
        // try parse
        const json = await safeJson(resp);
        if(resp.ok){
          resolve(json || { status: 'ok-nojson' });
        } else {
          resolve(json || { status: 'error' });
        }
      }).catch(err=>{
        clearTimeout(tid);
        resolve({ status: 'error', message: err && err.name === 'AbortError' ? 'timeout' : (err && err.message) || 'network' });
      });
    });
  }

  /* ----------------- loadUcapanFromServer -----------------
     Try fetch GET first; on CORS failure fallback to JSONP (Apps Script supports callback).
     Expects server to return {status:'success', items:[{timestamp,nama,ucapan},...]}
  -----------------------------------------------------------*/
  async function loadUcapanFromServer(){
    const container = document.getElementById('bubblesContainer');
    if(!container) return false;
    // show quick loading state (optional)
    // attempt fetch GET
    const url = UCAPAN_WS_URL + '?api=ucapan';
    try {
      const resp = await fetch(url, { method: 'GET', cache: 'no-cache' });
      // If CORS blocked, fetch will throw or response.ok but no CORS header; may still fail on reading body.
      const parsed = await tryParseLenient(resp);
      if(parsed && (Array.isArray(parsed) || parsed.items || parsed.data)){
        renderUcapanFromParsed(parsed, container);
        return true;
      } else {
        // not useful -> try JSONP
        throw new Error('no items in GET response');
      }
    } catch(err){
      // fallback JSONP
      return new Promise((resolve)=>{
        const cbName = '__ucapan_cb_' + Date.now();
        window[cbName] = function(data){
          try {
            renderUcapanFromParsed(data, container);
            resolve(true);
          } catch(e){
            resolve(false);
          } finally {
            // cleanup
            try { delete window[cbName]; } catch(e){}
            const s = document.getElementById(cbName);
            if(s && s.parentNode) s.parentNode.removeChild(s);
          }
        };
        // append script
        const script = document.createElement('script');
        script.id = cbName;
        script.src = UCAPAN_WS_URL + '?api=ucapan&callback=' + cbName;
        script.onerror = function(){
          try { delete window[cbName]; } catch(e){}
          if(script.parentNode) script.parentNode.removeChild(script);
          resolve(false);
        };
        document.body.appendChild(script);
      });
    }
  }

  // Try to parse many shapes
  async function tryParseLenient(resp){
    try {
      const j = await safeJson(resp);
      if(j) return j;
    } catch(e){}
    try {
      const txt = await resp.text();
      try { return JSON.parse(txt); } catch(e){}
      const m = txt.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
      if(m && m[1]) return JSON.parse(m[1]);
    } catch(e){}
    return null;
  }

  function renderUcapanFromParsed(parsed, container){
    // normalize array of items
    let items = null;
    if(Array.isArray(parsed)) items = parsed;
    else if(parsed.items && Array.isArray(parsed.items)) items = parsed.items;
    else if(parsed.data && Array.isArray(parsed.data)) items = parsed.data;
    else {
      // find first array in object values
      const maybe = Object.values(parsed).find(v => Array.isArray(v));
      if(maybe) items = maybe;
    }
    if(!items) items = [];

    // render (reverse so newest first if timestamp present reversed earlier on server)
    container.innerHTML = '';
    items.forEach(it=>{
      if(Array.isArray(it)){
        // row-style [timestamp, nama, ucapan]
        addBubbleToUI(it[1]||'', it[2]||'', it[0]||null, false, container);
      } else if(it && typeof it === 'object'){
        const nama = it.nama || it.Nama || it.NAMA || '';
        const ucapan = it.ucapan || it.Ucapan || it.UCAPAN || it.message || '';
        const ts = it.timestamp || it.Timestamp || it.time || null;
        addBubbleToUI(nama, ucapan, ts, false, container);
      }
    });
  }

  function addBubbleToUI(name, text, timestamp, prepend=true, containerEl){
    try {
      const container = containerEl || document.getElementById('bubblesContainer');
      if(!container) return;
      const bubble = document.createElement('div'); bubble.className = 'bubble';
      const timeLabel = timestamp ? (new Date(timestamp)).toLocaleString() : (new Date()).toLocaleString();
      bubble.innerHTML = '<div class="meta">'+escapeHtml(name)+' • <span style="font-size:11px;color:#999">'+ timeLabel +'</span></div><div class="msg">'+escapeHtml(text)+'</div>';
      if(prepend) container.insertBefore(bubble, container.firstChild);
      else container.appendChild(bubble);
    } catch(e){ console.warn('addBubbleToUI', e); }
  }

  /* ----------------- optimistic submit + fast feedback ----------------- */
  // on load: flush retry queue in background
  window.addEventListener('load', function(){ setTimeout(()=> flushRetryQueue(UCAPAN_WS_URL), 700); });

  /* sendWithBeaconOrFetch already defined above */

  // UCAPAN submit (button)
  const submitUcapanBtn = document.getElementById('submitUcapan');
  if(submitUcapanBtn){
    submitUcapanBtn.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      const nameEl = document.getElementById('ucap_name');
      const textEl = document.getElementById('ucap_text');
      const name = nameEl ? nameEl.value.trim() : '';
      const text = textEl ? textEl.value.trim() : '';
      const statusEl = document.getElementById('ucapanStatus');

      if(!name || !text){
        if(statusEl) { statusEl.style.display='block'; statusEl.textContent='Sila isi nama dan ucapan.'; statusEl.style.color='#b21b1b'; }
        return;
      }

      // optimistic UI - add bubble immediately
      const tsNow = new Date().toISOString();
      addBubbleToUI(name, text, tsNow, true);

      // clear & close popup
      if(nameEl) nameEl.value='';
      if(textEl) textEl.value='';
      const ucapanForm = document.getElementById('ucapanForm');
      if(ucapanForm) ucapanForm.style.display='none';
      if(statusEl) { statusEl.style.display='none'; }

      // quick toast
      showToast('Ucapan ditambah. Terima kasih!');

      // prepare payload
      const payload = { type:'ucapan', nama: name, ucapan: text, timestamp: tsNow };

      // send in background: try beacon/fetch short
      sendWithBeaconOrFetch(UCAPAN_WS_URL, payload).then((resp)=>{
        // consider beacon boolean ok or returned parsed object
        if(!resp || (resp && resp.ok !== true && !(resp.status === 'success' || resp.status === 'ok-nojson'))){
          // failed -> queue for retry
          pushToRetryQueue(payload);
        } else {
          // success -> try refresh authoritative list asynchronously (non-blocking)
          setTimeout(()=> loadUcapanFromServer(), 800);
        }
      }).catch(err=>{
        pushToRetryQueue(payload);
      });
    });
  }

  // RSVP submit (form)
  const rsvpForm = document.getElementById('rsvpInlineForm');
  if(rsvpForm){
    rsvpForm.addEventListener('submit', function(e){
      e.preventDefault();
      const nama = document.getElementById('rsvp_nama').value.trim();
      const jumlah = document.getElementById('rsvp_jumlah').value;
      const hadir = (rsvpForm.querySelector('input[name="hadir"]:checked')||{}).value || '';
      const rsvpStatus = document.getElementById('rsvpStatus');
      if(!nama || !jumlah){
        if(rsvpStatus){ rsvpStatus.style.display='block'; rsvpStatus.textContent='Sila lengkapkan nama dan jumlah ahli.'; rsvpStatus.style.color='#b21b1b'; }
        return;
      }
      if(rsvpStatus){ rsvpStatus.style.display='block'; rsvpStatus.textContent='RSVP dihantar. Terima kasih!'; rsvpStatus.style.color='#0a7a00'; }
      setTimeout(()=> { const p = document.getElementById('popupRsvpIframe'); if(p) p.style.display='none'; }, 700);
      rsvpForm.reset();

      const payload = { type:'rsvp', nama: nama, jumlah: jumlah, hadir: hadir, timestamp: new Date().toISOString() };
      sendWithBeaconOrFetch(RSVP_WS_URL, payload).then(res=>{
        if(!res || (res && !(res.ok === true || res.status === 'success' || res.status === 'ok-nojson'))){
          pushToRetryQueue(payload);
        }
      }).catch(()=> pushToRetryQueue(payload));
    });
  }

  /* ----------------- load initial ucapan ----------------- */
  // run on load
  (function(){ loadUcapanFromServer(); })();

  /* ----------------- JSONP helper (if needed separately) ----------------- */
  // not needed here (implemented inline in loadUcapanFromServer)

  /* ----------------- small UI helpers ----------------- */
  function showToast(msg, timeout=1400){
    try {
      const prev = document.getElementById('__ucapan_quick_toast');
      if(prev) prev.remove();
      const t = document.createElement('div');
      t.id='__ucapan_quick_toast';
      t.style.position='fixed';
      t.style.left='50%';
      t.style.transform='translateX(-50%)';
      t.style.bottom='130px';
      t.style.background='rgba(0,0,0,0.8)';
      t.style.color='#fff';
      t.style.padding='8px 12px';
      t.style.borderRadius='8px';
      t.style.zIndex='9999';
      t.style.fontSize='13px';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=> { try{ t.remove(); }catch(e){} }, timeout);
    } catch(e){}
  }

  /* ----------------- bottom bar, popups & image modal logic ----------------- */
  (function(){
    const images = document.querySelectorAll('.grid img');
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImg');
    const closeModalBtn = modal ? modal.querySelector('.close') : null;
    if(images && images.forEach){
      images.forEach(img => img.addEventListener('click', ()=>{ if(modal && modalImg){ modal.style.display='block'; modalImg.src = img.src; } }));
    }
    if(closeModalBtn) closeModalBtn.addEventListener('click', ()=>{ if(modal) modal.style.display='none'; });
    window.addEventListener('click', (ev)=>{ if(ev.target === modal) modal.style.display='none'; });

    const callBtn = document.getElementById('callBtn');
    const mapBtn = document.getElementById('mapBtn');
    const bottomRsvpBtn = document.getElementById('bottomRsvpBtn');
    const contactCard = document.getElementById('contactCard');
    const mapPopup = document.getElementById('mapPopup');
    const popupRsvp = document.getElementById('popupRsvp');
    const popupRsvpIframe = document.getElementById('popupRsvpIframe');
    const ucapanForm = document.getElementById('ucapanForm');

    function hideAll(){ if(contactCard) contactCard.style.display='none'; if(mapPopup) mapPopup.style.display='none'; if(popupRsvp) popupRsvp.style.display='none'; if(ucapanForm) ucapanForm.style.display='none'; if(popupRsvpIframe) popupRsvpIframe.style.display='none'; }

    if(callBtn) callBtn.addEventListener('click', (e)=>{ e.stopPropagation(); hideAll(); contactCard.style.display = (contactCard.style.display==='block')? 'none':'block'; });
    if(mapBtn) mapBtn.addEventListener('click', (e)=>{ e.stopPropagation(); hideAll(); mapPopup.style.display = (mapPopup.style.display==='block')? 'none':'block'; });
    if(bottomRsvpBtn) bottomRsvpBtn.addEventListener('click', (e)=>{ e.stopPropagation(); hideAll(); popupRsvp.style.display = (popupRsvp.style.display==='block')? 'none':'block'; });

    const openInlineRsvp = document.getElementById('openInlineRsvp');
    const openUcapanBtn = document.getElementById('openUcapanBtn');
    if(openInlineRsvp) openInlineRsvp.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); popupRsvp.style.display='none'; popupRsvpIframe.style.display='block'; const el=document.getElementById('rsvp_nama'); if(el) el.focus(); });
    if(openUcapanBtn) openUcapanBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); popupRsvp.style.display='none'; ucapanForm.style.display='block'; const el=document.getElementById('ucap_name'); if(el) el.focus(); });

    const closeRsvpIframeBtn = document.getElementById('closeRsvpIframeBtn');
    if(closeRsvpIframeBtn) closeRsvpIframeBtn.addEventListener('click', (e)=>{ e.stopPropagation(); popupRsvpIframe.style.display='none'; });

    const closeUcapanBtn = document.getElementById('closeUcapanBtn');
    if(closeUcapanBtn) closeUcapanBtn.addEventListener('click', (e)=>{ e.stopPropagation(); ucapanForm.style.display='none'; });

    document.addEventListener('click', function(e){
      const popupEls = [contactCard, mapPopup, popupRsvp, popupRsvpIframe, ucapanForm, modal];
      let inside=false;
      popupEls.forEach(p=>{ if(p && p.contains && p.contains(e.target)) inside=true; });
      const btns = [callBtn, mapBtn, bottomRsvpBtn];
      btns.forEach(b=>{ if(b && (b===e.target || b.contains(e.target))) inside=true; });
      if(!inside) hideAll();
    });
  })();

  /* ----------------- countdown ----------------- */
  (function(){
    function pad(n){ return String(n).padStart(2,'0'); }
    const eventDate = new Date('2026-01-03T11:00:00+08:00'); // match event date/time
    function updateCountdown(){
      const now = new Date();
      let diff = Math.max(0, Math.floor((eventDate - now) / 1000));
      const days = Math.floor(diff / 86400); diff %= 86400;
      const hours = Math.floor(diff / 3600); diff %= 3600;
      const mins = Math.floor(diff / 60); const secs = diff % 60;
      const daysEl = document.getElementById('days');
      const hoursEl = document.getElementById('hours');
      const minsEl = document.getElementById('mins');
      const secsEl = document.getElementById('secs');
      if(daysEl) daysEl.textContent = days;
      if(hoursEl) hoursEl.textContent = pad(hours);
      if(minsEl) minsEl.textContent = pad(mins);
      if(secsEl) secsEl.textContent = pad(secs);
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);
  })();

})();
</script>
</body>
</html>
